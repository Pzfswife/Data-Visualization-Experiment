<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>饼状图</title>
  <style>
    .container {
      margin: 30px auto;
      width: 600px;
      height: 300px;
      border: 1px solid #000;
    }
    polyline {
      fill: none;
      stroke: #000000;
      stroke-width: 2px;
      stroke-dasharray: 5px;
    }
  </style>
</head>
<body>
<div class="container">
  <svg width="100%" height="100%"></svg>
</div>

<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>
  window.onload = function() {
    var width = 600, height = 300;
    var main = d3.select('.container svg').append('g')
      .attr('transform', "translate(" + width / 2 + ',' + height / 2 + ')');

    // 数据：某同学2月份的支出
    var dataset = [
      { name: '购物', value: 983 },
      { name: '日常饮食', value: 300 },
      { name: '医药', value: 1400 },
      { name: '交通', value: 402 },
      { name: '杂费', value: 134 }
    ];

    // 计算总支出
    var total = d3.sum(dataset, function(d) { return d.value; });

    // 创建饼状图布局
    var pie = d3.layout.pie().value(function(d) { return d.value; }).sort(null);
    var pieData = pie(dataset);

    // 设置半径
    var radius = 100;
    var arc = d3.svg.arc()
      .innerRadius(0) // 设置内半径为0，即为全饼状图
      .outerRadius(radius);

    var outerArc = d3.svg.arc()
      .innerRadius(1.2 * radius)
      .outerRadius(1.2 * radius);

    // 创建图形元素
    var slices = main.append('g').attr('class', 'slices');
    var lines = main.append('g').attr('class', 'lines');
    var labels = main.append('g').attr('class', 'labels');

    // 绘制饼图的每个弧（slice）
    var arcs = slices.selectAll('g')
      .data(pieData)
      .enter()
      .append('path')
      .attr('fill', function(d, i) { return getColor(i); })
      .attr('d', function(d) { return arc(d); });

    // 添加标签
    var texts = labels.selectAll('text')
      .data(pieData)
      .enter()
      .append('text')
      .attr('dy', '0.35em')
      .attr('fill', function(d, i) { return getColor(i); })
      .text(function(d) { return d.data.name; })
      .style('text-anchor', function(d) { return midAngle(d) < Math.PI ? 'start' : 'end'; })
      .attr('transform', function(d) {
        var pos = outerArc.centroid(d);
        pos[0] = radius * (midAngle(d) < Math.PI ? 1.5 : -1.5);
        return 'translate(' + pos + ')';
      })
      .style('opacity', 1);

    // 添加标签的连接线（多段折线）
    var polylines = lines.selectAll('polyline')
      .data(pieData)
      .enter()
      .append('polyline')
      .attr('points', function(d) {
        var pos = outerArc.centroid(d);
        pos[0] = radius * (midAngle(d) < Math.PI ? 1.5 : -1.5);
        return [arc.centroid(d), outerArc.centroid(d), pos];
      })
      .style('opacity', 0.5);

    // 辅助函数：计算每个弧的中间角度
    function midAngle(d) {
      return d.startAngle + (d.endAngle - d.startAngle) / 2;
    }

    // 辅助函数：根据索引返回颜色
    function getColor(idx) {
      var palette = [
        '#2ec7c9', '#b6a2de', '#5ab9ef', '#ffb980', '#d87a80',
        '#8d98b3', '#e5cf0d', '#97b552', '#95706d', '#dc69aa',
        '#07a2a4', '#9a7fd1', '#588dd5', '#f5994e', '#c05050',
        '#59678c', '#c9ab00', '#7eb00a', '#6f5553', '#c14089'
      ];
      return palette[idx % palette.length];
    }
  };
</script>
</body>
</html>
